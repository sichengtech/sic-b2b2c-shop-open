"use strict";!function(e,t){"function"==typeof define&&define.amd?define(t):e.MyUpload=t()}(window,function(){function e(){this.obj={}}function r(e,t){t?t.msg(e):alert(e)}function t(e){return"number"==typeof e?e:10}var i,o,s,n=new(e.prototype.on=function(e,t){this.obj[e]||(this.obj[e]=[]),this.obj[e].push(t)},e.prototype.emit=function(){for(var e=Array.prototype.shift.call(arguments),t=this.obj[e],i=0;i<t.length;i++)t[i].apply(t[i],arguments)},e),a=(i=function(){var e=document.createElement("link");document.head.appendChild(e),e.setAttribute("rel","stylesheet"),e.setAttribute("href",(window.MYUPLOAD_PREFIX_URL||"")+"MyUpload/jquery-magnific-popup/magnific-popup.css"),e.setAttribute("type","text/css");var t=document.createElement("script");document.body.appendChild(t),t.setAttribute("type","text/javascript"),t.setAttribute("src",(window.MYUPLOAD_PREFIX_URL||"")+"MyUpload/jquery-magnific-popup/jquery.magnific-popup.min.js"),t.onload=function(){n.emit("script")}},o="",function(){return i&&(s=i.apply(o||this,arguments),i=null),s});function p(e){this.datas=[],this.count=0,this.ratio=window.devicePixelRatio||1,this.thumbnailWidth=100*this.ratio,this.thumbnailHeight=100*this.ratio,this.lay=window.layer||null,this.swf=window.MYUPLOAD_PREFIX_URL+"MyUpload/webuploader/Uploader.swf",this.uploadCount=t(e.fileNumLimit),this.fileNumLimit=t(e.fileNumLimit),this.againUpload=function(e){return!(!e&&void 0!==e)}(e.againUpload),this.uploadSuccess=e.uploadSuccess,this.uploadError=e.uploadError,this.uploadComplete=e.uploadComplete,this.uploadDelete=e.uploadDelete,this.beforeFile=e.beforeFile,this.options=e,this.expectParam(),a()}return p.prototype.init=function(e){var p=this,s=e;if("[object Array]"!==Object.prototype.toString.call(s))return r("init参数错误",p.lay),!1;$.each(s,function(e,t){if(!t)return!1;var i,o,s=(i=p.againUpload?$('<div class="file-item thumbnail eached"><a><img class="echoed"></a><div class="remove-this"><i class="icon-my"><img src="'+window.MYUPLOAD_PREFIX_URL+'MyUpload/images/del.png" style="width: 18px; height: 18px; margin-top: 6px;"></i></div><div class="load"></div></div>'):$('<div class="file-item thumbnail eached"><a><img class="echoed"></a><div class="load"></div></div>')).find("a img"),n=i.find("a"),a=i.find("div.load");a.text("历史图片加载中"),void 0!==p.options.formData&&p.options.formData.isSafe?(console.log("abc"),"string"==typeof p.options.accessKey&&(o=p.options.accessKey,n.attr("href",t+"?accessKey="+o),s.attr("src",t+"@!100X100?accessKey="+o))):(console.log(s,t),s.attr("src",t),n.attr("href",t)),$(p.options.container+" .gallery").append(i),s.each(function(e,t){$(t).load(function(){a.text("图片加载完成"),setTimeout(function(){a.text("历史图片")},600)})})}),p.uploadCount=p.fileNumLimit-s.length,p.removerFileMessage(p.options,p.shape.options),$(p.options.container+" .eached .remove-this").click(function(){var i=$($(this).parent().find("a img")).attr("src").split("@")[0],o=0;$.each(p.datas,function(e,t){t.url===i&&(o=e,s.splice(e,1))}),"function"==typeof p.uploadDelete&&p.uploadDelete(i),p.datas.splice(o,1),$(this).parent().remove(),p.removerFileMessage(p.options,p.shape.options),p.uploadCount=p.fileNumLimit-s.length})},p.prototype.expectParam=function(){return"[object Object]"!==Object.prototype.toString.call(this.options)?(r("createUpload()参数必须是对象",this.lay),!1):(2===this.options.buttonStyle||3===this.options.buttonStyle?$("head").prepend('<link rel="stylesheet" href="'+window.MYUPLOAD_PREFIX_URL+'MyUpload/css/button.css">'):1!==this.options.buttonStyle&&void 0!==this.options.buttonStyle||$("head").prepend('<link rel="stylesheet" href="'+window.MYUPLOAD_PREFIX_URL+'MyUpload/css/imgButton.css">'),this.options.server&&"string"==typeof this.options.server?this.options.container&&"string"==typeof this.options.container?void 0===$(this.options.container)[0]?(r("上传容器不存在"+this.options.container,this.lay),!1):(this.establishInitDOM(),void this.createUpload()):(r("container为空或不是为string类型",this.lay),!1):(r("server为空或不是为string",this.lay),!1))},p.prototype.establishInitDOM=function(){var e,t,i=this.options.container;return"string"!=typeof i?(r("containerId不是string类型",this.lay),!1):"number"!=typeof this.options.buttonStyle&&void 0!==this.options.buttonStyle?(r("buttonStyle不是number类型",this.lay),!1):void(1===this.options.buttonStyle||void 0===this.options.buttonStyle?(e='<i><img src="'+window.MYUPLOAD_PREFIX_URL+'MyUpload/images/add.png"></i>',t=$('<div id="fileList'+i.slice(1)+'" class="fileList-1 uploader-list-1 clear gallery"></div><div id="filePicker'+this.options.container.slice(1)+'" class="filePicker-1">'+e+"</div>"),$(i).append(t).addClass("uploader-container")):2===this.options.buttonStyle?(e="选择上传图片",t=$('<div id="fileList'+i.slice(1)+'" class="fileList uploader-list clear gallery"></div><div class="filePicker" id="filePicker'+this.options.container.slice(1)+'">'+e+"</div>"),$(i).append(t)):3===this.options.buttonStyle&&(e="选择上传图片",t=$('<div class="filePicker" id="filePicker'+i.slice(1)+'">'+e+'</div><div id="fileList'+i.slice(1)+'" class="fileList uploader-list clear gallery"></div>'),$(i).append(t)))},p.prototype.removerFileMessage=function(e,t){var i=$(e.container).find(".file-item.thumbnail").length;1!==e.buttonStyle&&void 0!==e.buttonStyle||(i>=e.fileNumLimit&&$(t.pick).hide(),i<e.fileNumLimit&&$(t.pick).show())},p.prototype.errorType=function(e,t){var i=t.accept[0].extensions,o=$(t.dnd+" .file-item.thumbnail").length;r("Q_TYPE_DENIED"==e?"请上传"+i+"格式文件":"Q_EXCEED_SIZE_LIMIT"==e?"文件总大小不能超过"+t.fileSingleSizeLimit/1024/1024*t.fileNumLimit+"MB":"Q_EXCEED_NUM_LIMIT"==e?"文件超出"+o+"个, 自动选取位置靠前的文件":"F_EXCEED_SIZE"==e?"文件大小不能超过"+t.fileSingleSizeLimit/1024/1024+"MB":"F_DUPLICATE"==e?"重复的图片、请重新上传":"上传出错，请重新上传",this.lay)},p.prototype.verifyFormData=function(){return"[object Object]"===Object.prototype.toString.call(this.options.formData)?("boolean"==typeof this.options.isSafe&&(this.options.formData.isSafe=this.options.isSafe),this.options.formData):{}},p.prototype.verifyType=function(e){return"images"===e?{title:"Images",extensions:"jpg,jpeg,png,bmp"}:"file"===e?{title:"上传文件",extensions:"jpg,jpeg,bmp,png,pdf,ppt,pptx,xls,xlsx,doc,docx,zip,rar"}:"object"==typeof e?"custom"===e.type&&"string"==typeof e.extensions?{title:"自定义",extensions:e.extensions}:(r("accept参数有误",this.lay),!1):{title:"Images",extensions:"jpg,jpeg,png,bmp"}},p.prototype.initParams=function(){return{auto:!0,dnd:function(e){return"number"==typeof e.buttonStyle&&1===e.buttonStyle||void 0===e.buttonStyle?e.container:"#fileList"+e.container.slice(1)}(this.options),paste:this.options.container,pick:"#filePicker"+this.options.container.slice(1),disableGlobalDnd:!0,swf:this.swf,server:this.options.server,accept:this.verifyType(this.options.accept),formData:this.verifyFormData(),fileNumLimit:99,fileSingleSizeLimit:this.options.fileSingleSizeLimit||2097152,duplicate:function(e){return"[object Boolean]"!==Object.prototype.toString.call(e)||e}(this.options.duplicate),compress:function(e){return"[object Object]"===Object.prototype.toString.call(e)?e:""}(this.options.compress),prepareNextFile:this.options.prepareNextFile||""}},p.prototype.reset=function(){var i=this;$.each(this.datas,function(e,t){i.shape.removeFile(t.WUfile,!0)}),this.datas=[],$(this.options.container).find(".file-item").remove(),this.removerFileMessage(this.options,this.shape.options),this.count=0},p.prototype.createUpload=function(){var a=this;if(a.shape=a.options.container.slice(1),!WebUploader.Uploader.support())throw alert("Web Uploader 不支持您的浏览器！如果你使用的是IE浏览器，请尝试安装或升级 Adobe Flash Player"),new Error("WebUploader does not support the browser you are using.");"images"!==a.options.accept&&void 0!==a.options.accept||($("#fileList"+a.options.container.slice(1)+" .gallery").magnificPopup?$(a.options.container+" .gallery").magnificPopup({delegate:"a",type:"image",gallery:{enabled:!0}}):n.on("script",function(){$("#fileList"+a.options.container.slice(1)+" .gallery").magnificPopup({delegate:"a",type:"image",gallery:{enabled:!0}})})),a.shape=new WebUploader.Uploader(a.initParams()),a.shape.on("beforeFileQueued",function(e){"function"==typeof a.beforeFile&&a.beforeFile(e.source.getSource())}),a.shape.on("fileQueued",function(o){if(a.uploadCount<=a.count)return a.errorType("Q_EXCEED_NUM_LIMIT",a.shape.options),!1;a.count++;var i=$('<div id="'+o.id+'" class="file-item thumbnail"><a><img></a><div class="remove-this"></div></div>'),s=i.find("img");if($("#fileList"+a.options.container.slice(1)).append(i),a.shape.makeThumb(o,function(e,t){if(e)return i.find("a").attr("href","./images/no-preview.png"),void("pdf"===o.ext||"ppt"===o.ext||"pptx"===o.ext?s.replaceWith('<span class="preview"></span><img src="'+window.MYUPLOAD_PREFIX_URL+'MyUpload/images/pdf.png" class="preview-img" alt="不能预览">'):"xls"===o.ext||"xlsx"===o.ext?s.replaceWith('<span class="preview"></span><img src="'+window.MYUPLOAD_PREFIX_URL+'MyUpload/images/xlsx.png" class="preview-img" alt="不能预览">'):"doc"===o.ext||"docx"===o.ext?s.replaceWith('<span class="preview"></span><img src="'+window.MYUPLOAD_PREFIX_URL+'MyUpload/images/doc.png" class="preview-img" alt="不能预览">'):"zip"===o.ext?s.replaceWith('<span class="preview"></span><img src="'+window.MYUPLOAD_PREFIX_URL+'MyUpload/images/zip.png" class="preview-img" alt="不能预览">'):"rar"===o.ext?s.replaceWith('<span class="preview"></span><img src="'+window.MYUPLOAD_PREFIX_URL+'MyUpload/images/rar.png" class="preview-img" alt="不能预览">'):s.replaceWith('<span class="preview">上传的文件不支持预览。</span><img src="'+window.MYUPLOAD_PREFIX_URL+'MyUpload/images/no-preview.png" alt="不能预览">'));s.attr("src",t)},a.thumbnailWidth,a.thumbnailHeight),i.find(".remove-this").append('<i class="icon-my"><img src="'+window.MYUPLOAD_PREFIX_URL+'MyUpload/images/del.png" style="width: 18px; height: 18px; margin-top: 6px;"></i>'),a.removerFileMessage(a.options,a.shape.options),$("#fileList"+a.options.container.slice(1)).on("click",".remove-this",function(){if($(this).parent().attr("id")==o.id){var i=0;$.each(a.datas,function(e,t){t.WUfile&&t.WUfile.id===o.id&&(i=e,"function"==typeof a.uploadDelete&&a.uploadDelete(t))}),a.shape.removeFile(o,!0),a.datas.splice(i,1),$(this).parent().remove(),a.removerFileMessage(a.options,a.shape.options),a.count=a.count-1}}),a.options.auto)return!1;a.options.tokenPath&&($.ajaxSettings.async=!1,$.getJSON(a.options.tokenPath+"?"+(new Date).getTime()+Math.random(),function(e){o.token=e.token}),$.ajaxSettings.async=!0)}),a.shape.on("uploadProgress",function(e,t){if(a.options.auto)return!1;var i=$("#"+e.id),o=i.find(".progress span");o.length||(o=$('<p class="progress"><span></span></p>').appendTo(i).find("span")),o.css("width",100*t+"%")}),a.shape.on("uploadBeforeSend",function(e,t){if(a.options.auto)return!1;t.token=e.file.token,e.file.isSafe=t.isSafe||""}),a.shape.on("uploadSuccess",function(e,t){if(a.options.auto)return!1;var i,o=$("#"+e.id),s=o.find("div.success"),n=o.find("a");if(!s.length)if(s=$('<div class="success"></div>').appendTo(o),e.isSafe){if("string"!=typeof a.options.accessKey)return r("accessKey错误",a.lay),!1;i=a.options.accessKey,"images"===a.options.accept||void 0===a.options.accept?n.attr("href",t.url+"?accessKey="+i):n.attr("href","javascript:;")}else"images"===a.options.accept||void 0===a.options.accept?n.attr("href",t.url):n.attr("href","javascript:;");"上传成功"==t.statusText?(s.text("上传成功"),t.WUfile=e,a.datas.push(t)):(s.text("上传失败").css({color:"red"}),n.find("span").html("上传失败，请检查文件格式，再上传").css({color:"red","font-size":"12px"})),"function"==typeof a.uploadSuccess&&a.uploadSuccess(e,t)}),a.shape.on("uploadError",function(e,t){var i=$("#"+e.id),o=i.find("p.error");o.length||(o=$('<div class="error"></div>').appendTo(i)),o.text("上传出错"),"function"==typeof a.uploadError&&a.uploadError(e,t)}),a.shape.on("uploadComplete",function(e){$("#"+e.id).find(".progress").remove(),"function"==typeof a.uploadComplete&&a.uploadComplete(e)}),a.shape.on("error",function(e){a.errorType(e,a.shape.options)}),a.shape.refresh()},p});